---
// src/pages/contact.astro
import Base from "../../layouts/Base.astro";
import site from "../../content/settings/global.md";

const fm: any = (site as any).frontmatter ?? {};
const companyName = fm.company_name ?? "Mid MO Tours";
const phone = fm.phone ?? "";
const email = fm.email ?? "";
const hours = fm.hours ?? "";
const addr = fm.address ?? {};
const telHref = phone ? `tel:${phone.replace(/[^+\d]/g, "")}` : "";
const mailHref = email ? `mailto:${email}` : "";

function joinAddress(a: any) {
  return [a?.street, [a?.city, a?.state].filter(Boolean).join(", "), a?.zip].filter(Boolean).join(" ¬∑ ");
}
---

<Base
  title="Contact | Mid MO Tours"
  description="Get in touch to book a tour, plan a custom itinerary, or ask a question.">
  <section class="bg-white">
    <div class="mx-auto max-w-7xl px-4 py-12 grid gap-10 lg:grid-cols-3">
      <!-- Contact info -->
      <aside class="lg:col-span-1">
        <h1 class="text-3xl font-semibold tracking-tight">Contact</h1>
        <p class="mt-3 text-slate-600">We‚Äôll get back to you as soon as we can.</p>

        <div class="mt-6 rounded-2xl border p-6 shadow-sm bg-slate-50">
          <h2 class="text-lg font-semibold">{companyName}</h2>
          {joinAddress(addr) && <p class="mt-2 text-sm text-slate-600">{joinAddress(addr)}</p>}
          <ul class="mt-3 space-y-2 text-sm">
            {
              phone && (
                <li>
                  <a href={telHref} class="text-slate-700 hover:text-slate-950">
                    üìû {phone}
                  </a>
                </li>
              )
            }
            {
              email && (
                <li>
                  <a href={mailHref} class="text-slate-700 hover:text-slate-950">
                    ‚úâÔ∏è {email}
                  </a>
                </li>
              )
            }
            {hours && <li class="text-slate-600">üïí {hours}</li>}
          </ul>
        </div>
      </aside>

      <!-- Form -->
      <div id="custom-tour" class="lg:col-span-2">
        <form
          name="contact"
          method="POST"
          action="/contact/success"
          data-netlify="true"
          netlify-honeypot="bot-field"
          class="rounded-2xl border p-6 shadow-sm">
          <!-- required for Netlify Forms -->
          <input type="hidden" name="form-name" value="contact" />
          <p class="hidden">
            <label>Don‚Äôt fill this out: <input name="bot-field" /></label>
          </p>

          <!-- Attribution & context (filled by JS) -->
          <input type="hidden" name="page_url" />
          <input type="hidden" name="page_title" />
          <input type="hidden" name="referrer" />
          <input type="hidden" name="utm_source" />
          <input type="hidden" name="utm_medium" />
          <input type="hidden" name="utm_campaign" />
          <input type="hidden" name="utm_term" />
          <input type="hidden" name="utm_content" />
          <input type="hidden" name="timestamp" />

          <div class="grid gap-4 sm:grid-cols-2">
            <div class="sm:col-span-1">
              <label class="block text-sm font-medium text-slate-900" for="name">Full name</label>
              <input
                id="name"
                name="name"
                type="text"
                required
                autocomplete="name"
                class="mt-1 block w-full rounded-lg border px-3 py-2 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-600"
              />
            </div>
            <div class="sm:col-span-1">
              <label class="block text-sm font-medium text-slate-900" for="email">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                required
                autocomplete="email"
                inputmode="email"
                class="mt-1 block w-full rounded-lg border px-3 py-2 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-600"
              />
            </div>
            <div class="sm:col-span-1">
              <label class="block text-sm font-medium text-slate-900" for="phone">Phone (optional)</label>
              <input
                id="phone"
                name="phone"
                type="tel"
                autocomplete="tel"
                inputmode="tel"
                class="mt-1 block w-full rounded-lg border px-3 py-2 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-600"
              />
            </div>
            <div class="sm:col-span-1">
              <label class="block text-sm font-medium text-slate-900" for="topic">Topic</label>
              <select
                id="topic"
                name="topic"
                class="mt-1 block w-full rounded-lg border px-3 py-2 text-slate-900 focus:outline-none focus:ring-2 focus:ring-emerald-600">
                <option value="booking">Booking the Standard Tour</option>
                <option value="custom">Requesting a Custom Tour</option>
                <option value="package">Packages</option>
                <option value="other">Something else</option>
              </select>
            </div>
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium text-slate-900" for="message">Message</label>
              <textarea
                id="message"
                name="message"
                required
                rows={6}
                class="mt-1 block w-full rounded-lg border px-3 py-2 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-600"
                placeholder="Tell us your dates, group size, and interests."></textarea>
            </div>

            <!-- Optional: Netlify reCAPTCHA (enable in dashboard, then uncomment) -->
            {
              /*
            <div class="sm:col-span-2">
              <div data-netlify-recaptcha="true"></div>
            </div>
            */
            }
          </div>

          <div class="mt-5 flex items-center justify-between">
            <p class="text-sm text-slate-600">
              By submitting, you agree to our
              <a class="text-emerald-700 hover:underline" href="/privacy">Privacy Policy</a>.
            </p>
            <button type="submit" class="btn btn-primary">Send Message</button>
          </div>
        </form>

        <!-- Lightweight client script: preselect topic + fill hidden fields -->
        <script is:inline>
          (function () {
            const form = document.forms["contact"];
            if (!form) return;

            // Helpers
            const params = new URLSearchParams(location.search);
            const get = (k) => (params.get(k) || "").trim();

            // 1) Preselect Topic
            // Priority: explicit ?topic=... > referring path hints
            const topicEl = form.querySelector("#topic");
            const qTopic = (get("topic") || "").toLowerCase();
            const hints = ["booking", "custom", "package", "other"];
            const ref = document.referrer || "";

            const fromPackages = /\/packages?(\b|\/)/i.test(ref) || /(^|&)from=packages(&|$)/i.test(location.search);

            const desired = hints.includes(qTopic) ? qTopic : fromPackages ? "package" : null;

            if (topicEl && desired) {
              topicEl.value = desired;
            }

            // 2) Optional: seed message when coming from a package
            if (desired === "package") {
              const msg = form.querySelector("#message");
              if (msg && !msg.value) {
                msg.value = "Interested in a package. Dates, group size, and any special stops:";
              }
            }

            // 3) Attribution / context
            const setVal = (name, val) => {
              const el = form.querySelector(`input[name="${name}"]`);
              if (el) el.value = val || "";
            };

            setVal("page_url", location.href);
            setVal("page_title", document.title);
            setVal("referrer", document.referrer);

            ["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content"].forEach((k) => setVal(k, get(k)));

            setVal("timestamp", new Date().toISOString());
          })();
        </script>
      </div>
    </div>
  </section>
</Base>
